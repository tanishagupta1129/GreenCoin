{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Coin - Register</title>
    <link rel="stylesheet" href="{% static 'mainapp/css/signup.css' %}">
    <style>
        /* âœ… Success Banner Styling */
        #successBanner {
            position: fixed;
            top: 105px; /* Header height is 100px, so this appears slightly below */
            left: 50%;
            transform: translateX(-50%);
            background-color: #d4edda;
            color: #155724;
            padding: 15px 20px;
            border-left: 5px solid #28a745;
            font-weight: 500;
            font-size: 20px;
            max-width: 600px;
            width: 90%;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
            z-index: 1100;
        }

        #successBanner img {
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .alert {
        padding: 10px 20px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
        font-size: 16px;
    }
    .alert-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    </style>
</head>
<body>

    <!-- âœ… Success Banner -->
    <div id="successBanner">
        <img src="{% static 'mainapp/images/logo.png' %}" alt="Green Coin Logo"style="width:40px; height:40px; border-radius:100%;">
        <span style="font-size: 20px;">Thank you for joining Green Coin ðŸŒ± â€” your small action is a giant step toward a greener planet!</span>
    </div>

    <!-- âœ… Header -->
    <header>
        <nav>
            <ul>

                <li><a href="{% url 'index' %}">Home</a></li>
                <li><a href="{% url 'submit_proof' %}">Submit Proof</a></li>
                <li><a href="{% url 'leaderboard' %}">Leaderboard</a></li>
                <li><a href="{% url 'reward' %}">Rewards</a></li>
                <li><a href="{% url 'awareness' %}">Eco Benefits</a></li>

                {% if not request.session.user_id %}
                <li><a href="{% url 'login' %}">Login</a></li>
                 {% endif %}
            </ul>
        </nav>
        <div class="logo">
            <a href="{% url 'profile' %}">
                <img src="{% static 'mainapp/images/profile.png' %}" alt="Profile" style="width:40px; height:40px; border-radius:100%;">
            </a>
        </div>
    </header>

    <!-- âœ… Register Section -->
    <section class="register-section">
        <div class="register-box">
            <img src="{% static 'mainapp/images/logo.png' %}" style="width:40px; height:40px; border-radius:100%;">
            <h2>Register for Green Coin</h2>

            

{% if messages %}
    {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
    {% endfor %}
{% endif %}

            <form method="post">
                {% csrf_token %}

                {% if not request.session.temp_user %}
                  <!-- STEP 1: SIGNUP FORM -->
                 <label for="fullname">Full Name:</label>
                 <input type="text" name="fullname" required>

                 <label for="email">Email:</label>
                 <input type="email" name="email" required>

                 <label for="password">Password:</label>
                <div style="position: relative;">
                    <input type="password" id="password" name="password" required>
                    <button type="button" id="togglePassword">Show</button>
                </div>

                 <button type="submit" name="send_otp">Send OTP</button>

                {% else %}
                 <!-- STEP 2: OTP VERIFICATION -->

                 <label for="otp">Enter OTP:</label>
                 <input type="text" name="otp" maxlength="6" required>

                 <button type="submit" name="verify_otp">Verify & Register</button>
                {% endif %}
            </form>

        </div>
    </section>
    {% if messages %}
        {% for message in messages %}
          <div id="success-message"
             data-message="{{ message }}"
             data-tag="{{ message.tags }}"
             style="display:none;">
          </div>
        {% endfor %}
    {% endif %}


    <!-- âœ… Footer -->
    <div id="Footer">
        <img src="{% static 'mainapp/images/logo.png' %}" alt="Green Coin Logo" class="footer-logo"style="width:40px; height:40px; border-radius:100%;">  
        <p><i>"Nature Rewards Those Who Care!"</i></p>
        <p>Contact us at: <a href="mailto:greencoin.support@example.com">greencoin.support@example.com</a></p>
        <p>&copy; 2025 Green Coin. All rights reserved.</p>
    </div>

    
   <div id="success-message" 
     data-message="{% for message in messages %}{{ message }}{% endfor %}" 
     data-tag="{% for message in messages %}{{ message.tags }}{% endfor %}" 
     style="display: none;"></div>
 

    <!-- âœ… JS Script -->
<script>
window.addEventListener("DOMContentLoaded", function () {
    const successDiv = document.getElementById("success-message");
    if (successDiv) {
        const message = successDiv.dataset.message;
        const tag = successDiv.dataset.tag;
        if (tag === "success" && message.includes("Thank you for joining Green Coin ðŸŒ±")) {
            const banner = document.getElementById("successBanner");
            banner.style.display = "block";
            setTimeout(() => {
                window.location.href = "{% url 'profile' %}";
            }, 2500);
        }
    }

    // âœ… Input Formatting
    const nameInput = document.getElementById("fullname");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const toggleBtn = document.getElementById("togglePassword");
    const form = document.querySelector("form");

    if (nameInput) {
        nameInput.addEventListener("input", () => {
            const value = nameInput.value;
            const nameParts = value.split(/\s+/);
            const capitalized = nameParts.map(word =>
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(" ");
            const cursorPosition = nameInput.selectionStart;
            nameInput.value = capitalized;
            nameInput.setSelectionRange(cursorPosition, cursorPosition);
        });
    }

    if (emailInput) {
        emailInput.addEventListener("blur", async () => {
            const email = emailInput.value.trim();
            if (email) {
                try {
                    const response = await fetch("/check-email/?email=" + encodeURIComponent(email));
                    const data = await response.json();
                    if (data.exists) {
                        alert("This email is already registered.");
                        emailInput.dataset.exists = "true";
                    } else {
                        emailInput.dataset.exists = "false";
                    }
                } catch (error) {
                    console.error("Email check failed:", error);
                }
            }
        });
    }

    if (form) {
        form.addEventListener("submit", function (e) {
            let isValid = true;
            const name = nameInput.value.trim();
            const emailExists = emailInput.dataset.exists === "true";
            const password = passwordInput.value;

            const words = name.split(/\s+/);
            words.forEach(word => {
                if (word.length <= 2) {
                    isValid = false;
                }
            });

            if (!isValid) alert("Please Enter Your Valid Name.");
            if (emailExists) {
                alert("Email already registered. Please use another email.");
                isValid = false;
            }
            if (password.length < 6) {
                alert("Password must be at least 6 characters long and contain at least one number & one special character.");
                isValid = false;
            } else if (!/\d/.test(password)) {
                alert("Password must contain at least one number.");
                isValid = false;
            } else if (!/[!@#$%^&*(),.?\":{}|<>]/.test(password)) {
                alert("Password must contain at least one special character.");
                isValid = false;
            }

            if (!isValid) e.preventDefault();
        });
    }

    if (toggleBtn && passwordInput) {
        toggleBtn.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            toggleBtn.textContent = type === 'password' ? 'Show' : 'Hide';
        });
    }
}); // âœ… This closing bracket was missing
</script>


</body>
</html>